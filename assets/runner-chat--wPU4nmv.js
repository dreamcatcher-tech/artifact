var N=(a,t,s)=>{if(!t.has(a))throw TypeError("Cannot "+s)};var e=(a,t,s)=>(N(a,t,"read from private field"),s?s.call(a):t.get(a)),m=(a,t,s)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,s)},h=(a,t,s,o)=>(N(a,t,"write to private field"),o?o.call(a,s):t.set(a,s),s);var O=(a,t,s)=>(N(a,t,"access private method"),s);import{a as r,D as v,b as F,O as $,s as K}from"./index-DHDzCljP.js";import{m as M}from"./index-qDgfU7EV.js";import{a as Y,r as Z,w as j,b as z}from"./io-hooks-NnKsiyKm.js";var G={VITE_OPENAI_API_KEY:"c2stVWRlRWFIWWZxQVBkQ1czZVNuTmFUM0JsYmtGSkRSTnp5cW9rRjFmR0ZBdE80Sm9S",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const f=v("AI:runner-chat"),{VITE_OPENAI_API_KEY:D}=G;if(!D)throw new Error("missing openai api key");const Q=F.Buffer.from(D,"base64").toString("utf-8"),U=new $({apiKey:Q,dangerouslyAllowBrowser:!0}),ot=async({help:a,text:t})=>(r(typeof a=="object","help must be an object"),r(typeof t=="string","text must be a string"),await(await R.create(a)).prompt(t));var g,S,E,b,u,w,C,J,x,W;const y=class y{constructor(){m(this,C);m(this,x);m(this,g,void 0);m(this,S,void 0);m(this,E,[]);m(this,b,void 0);m(this,u,void 0)}static async create(t){var o,i;r(typeof t=="object","help must be an object");const s=JSON.stringify(t);if(!e(y,w).has(s)){const n=new y;h(n,u,"/chat-1.session.json"),h(n,g,t.instructions.join(`
`).trim()),h(n,S,((o=t.config)==null?void 0:o.model)||"gpt-4-1106-preview"),await O(i=n,x,W).call(i,t.commands),e(y,w).set(s,n)}return e(y,w).get(s)}async prompt(t){var i;r(typeof t=="string","text must be a string"),r(t.length,"text must not be empty");let s=[];await Y(e(this,u))&&(s=await Z(e(this,u))),r(Array.isArray(s),"messages must be an array"),e(this,g)&&(((i=s[0])==null?void 0:i.role)==="system"&&s.shift(),s.unshift({role:"system",content:e(this,g)})),t&&s.push({role:"user",content:t});const o=await O(this,C,J).call(this,s);return f("assistant",o),o}async executeTools(t){r(Array.isArray(t),"messages must be an array"),t=[...t];const s=t[t.length-1];if(!s.tool_calls)return s.content;f("toolCalls count:",s.tool_calls.length);for(const o of s.tool_calls){const{function:{name:i,arguments:n},id:d}=o;f("tool call:",i,n),r(e(this,b)[i],`missing action: ${i}`);const c={role:"tool",tool_call_id:d};t.push(c),await j(t,e(this,u));try{const p=JSON.parse(n),l=await e(this,b)[i](p);f("tool call result:",l),l===void 0||typeof l=="string"?c.content=l||"":c.content=JSON.stringify(l,null,2)}catch(p){f("tool call error:",p),c.content=JSON.stringify(K(p),null,2)}}return await j(t,e(this,u)),O(this,C,J).call(this,t)}};g=new WeakMap,S=new WeakMap,E=new WeakMap,b=new WeakMap,u=new WeakMap,w=new WeakMap,C=new WeakSet,J=async function(t){var n,d,c,p,l,P;const s={model:e(this,S),temperature:0,messages:[...t],stream:!0,seed:1,tools:e(this,E)},o={role:"assistant"};t.push(o),await j(t,e(this,u)),f("streamCall started");const i=await U.chat.completions.create(s);f("streamCall placed");for await(const T of i){const V=(d=(n=T.choices[0])==null?void 0:n.delta)==null?void 0:d.content;V&&(o.content||(o.content=""),o.content+=V);const I=(p=(c=T.choices[0])==null?void 0:c.delta)==null?void 0:p.tool_calls;if(I){r(Array.isArray(I),"toolCalls must be an array"),o.tool_calls||(o.tool_calls=[]);for(const k of I){const{index:_,...A}=k;r(Number.isInteger(_),"toolCalls index must be an integer"),o.tool_calls[_]||(o.tool_calls[_]={});const B={function:{arguments:((l=o.tool_calls[_].function)==null?void 0:l.arguments)||""}};(P=A==null?void 0:A.function)!=null&&P.arguments&&(B.function.arguments+=A.function.arguments),M(o.tool_calls[_],A,B)}}await j(t,e(this,u))}return f("streamCall complete"),this.executeTools(t)},x=new WeakSet,W=async function(t){r(Array.isArray(t),"commands must be an array");const s=[],o=new Set,i={};for(const n of t){f("loading command:",n);const[d,c]=n.split(":"),l=(await z(d))[c];r(l,`missing action: ${n}`),r(!o.has(c),`duplicate action: ${n}`),o.add(c),i[c]=l,s.push(L(c,l))}h(this,b,i),h(this,E,s)},m(y,w,new Map);let R=y;const L=(a,t)=>{const{api:s}=t;r(typeof s=="object","api must be an object"),r(typeof s.type=="string","api.type must be a string");const{...o}=s;return delete o.title,delete o.description,{type:"function",function:{name:a,description:s.description,parameters:o}}};export{ot as default};
